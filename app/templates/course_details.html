{% extends 'layout.html' %}

{% block content %}
<h2>{{ course.title }}</h2>

<div class="row">
    <!-- Left column for the image -->
    <div class="col-md-4">
        <div class="card mb-4 shadow-sm">
            <img src="{{ url_for('static', filename='img_course/' + course.courseImage) }}" class="card-img-top"
                alt="{{ course.title }}" style="height: 100%; object-fit: cover;">
        </div>
    </div>

    <!-- Right column for the course details -->
    <div class="col-md-8">
        <div class="card mb-4 shadow-sm">
            <div class="card-body">
                <h5 class="card-title">{{ course.title }}</h5>
                <p class="card-text"><strong>Description:</strong> {{ course.description }}</p>
                <p class="card-text"><strong>Price:</strong> ${{ course.price }}</p>
                <p class="card-text"><strong>Instructor:</strong> {{ course.instructor.name }}</p>
                <p class="card-text"><strong>Category :</strong> {{ course.category.name }}</p>
                <p class="card-text"><strong>Total Student:</strong> {{ course.total_students }}</p>


                {% if current_user.is_authenticated %}
                    {% if current_user.role == 'student' %}

                        {% if enrolled %}
                            <!-- Show Unenroll button if already enrolled -->
                            <form action="{{ url_for('course.unenroll', course_id=course.id) }}" method="POST">
                                <button type="submit" class="btn btn-danger btn-lg mt-3">Unenroll from this course</button>
                            </form>
                        {% else %}
                            <!-- Show Enroll button if not enrolled -->
                            <form action="{{ url_for('course.enroll', course_id=course.id) }}" method="POST">
                                <button type="submit" class="btn btn-primary btn-lg mt-3">Enroll in this course</button>
                            </form>
                        {% endif %}
                    {% endif %}

                    {% if current_user.role == 'instructor' %}
                        <!-- Instructor-specific buttons -->
                        <a href="{{ url_for('course.edit_course', course_id=course.id) }}" class="btn btn-warning btn-sm w-25">Edit</a>

                       
                    {% endif %}
                {% endif %}
            </div>
        </div>
    </div>
</div>

{% if current_user.is_authenticated %}
{% if current_user.role == 'student' %}
{% if is_enrolled %}
<h3>Lessons</h3>
<ul>
    {% for lesson in course.lessons %}
    <li><a href="{{ url_for('course.view_lesson', lesson_id=lesson.id) }}">{{ lesson.title }}</a></li>
    {% endfor %}
</ul>

<h3>Quizzes</h3>
<ul>
    {% for quiz in course.quizzes %}
    <li>
        <a href="{{ url_for('course.take_quiz', quiz_id=quiz.id) }}">{{ quiz.title }}</a>
        {% set attempt = quiz.attempts | selectattr('student_id', 'equalto', current_user.id) | first %}
        {% if attempt %}
        - <span style="color: green;">Score: {{ attempt.score }}%</span> (Already Attempted)
        {% endif %}
    </li>
    {% endfor %}
</ul>
{% else %}
<a href="{{ url_for('course.enroll', course_id=course.id) }}">Enroll in this course</a>
{% endif %}
{% elif current_user.role == 'instructor' and current_user.id == course.teacher_id %}
<h3>Manage Course Content</h3>
<a href="{{ url_for('course.add_lesson', course_id=course.id) }}">Add Lesson</a><br>
<a href="{{ url_for('course.add_quiz', course_id=course.id) }}">Add Quiz</a>

<h3>Lessons</h3>
<ul>
    {% for lesson in course.lessons %}
    <li>
        {{ lesson.title }}
        - <a href="{{ url_for('course.edit_lesson', lesson_id=lesson.id) }}">Edit Lesson</a>
    </li>
    {% endfor %}
</ul>

<h3>Quizzes</h3>
<ul>
    {% for quiz in course.quizzes %}
    <li>
        {{ quiz.title }}
        - <a href="{{ url_for('course.add_question', quiz_id=quiz.id) }}">Add Question</a>
        - <a href="{{ url_for('course.view_questions', quiz_id=quiz.id) }}">View/Edit Questions</a>
    </li>
    {% endfor %}
</ul>
{% endif %}
{% endif %}

<a href="{{ url_for('course.list_courses') }}">Back to Courses</a>
{% endblock %}
